name: Build project release task

env:
  IS_MAIN_BRANCH: ${{ endsWith(github.ref, 'refs/heads/main') }}

on:
  workflow_call:
    inputs:
      # Input to control whether to create a GitHub release
      github:
        required: false
        type: boolean
        default: false
      # Input to control whether to push the library to NuGet.org
      nuget:
        required: false
        type: boolean
        default: false

jobs:

  get-version:
    name: Get version information job
    uses: ./.github/workflows/get-version-task.yml
    secrets: inherit

  build-library:
    name: Build library job
    uses: ./.github/workflows/build-library-task.yml
    secrets: inherit
    with:
      # Conditional push to NuGet.org
      push: ${{ inputs.nuget }}

  github-release:
    name: Publish GitHub release job
    if: ${{ inputs.github }}
    runs-on: ubuntu-latest
    needs: [get-version, build-library]

    steps:

      - name: Checkout code step
        uses: actions/checkout@v6

      - name: Download library build artifacts job
        uses: actions/download-artifact@v7
        with:
          artifact-ids: ${{ needs.build-library.outputs.artifact-id }}
          path: ./Publish

      - name: Create GitHub release job
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          tag_name: ${{ needs.get-version.outputs.SemVer2 }}
          prerelease: ${{ env.IS_MAIN_BRANCH != 'true' }}
          files: |
            LICENSE
            README.md
            ./Publish/*
